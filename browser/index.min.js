require=function e(t,r,n){function i(s,u){if(!r[s]){if(!t[s]){var o=typeof require=="function"&&require;if(!u&&o)return o(s,!0);if(a)return a(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var f=r[s]={exports:{}};t[s][0].call(f.exports,function(e){var r=t[s][1][e];return i(r?r:e)},f,f.exports,e,t,r,n)}return r[s].exports}var a=typeof require=="function"&&require;for(var s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){},{}],MidiPlayer:[function(e,t,r){"use strict";var n={NOTES:[]};(function(){var e=[["C"],["C#","Db"],["D"],["D#","Eb"],["E"],["F"],["F#","Gb"],["G"],["G#","Ab"],["A"],["A#","Bb"],["B"]];var t=0;for(var r=-1;r<=9;r++){e.forEach(function(e){e.forEach(function(e){n.NOTES[t]=e+r});t++})}})();"use strict";var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,r,n){if(r)e(t.prototype,r);if(n)e(t,n);return t}}();function a(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var s=function(){function t(e,r){a(this,t);this.startTime=0;this.buffer=r||null;this.division;this.setIntervalId=null;this.tracks=[];this.tracksEnabled=[];this.tempo=100;this.tick=0;this.lastStatuses=[];this.lastTick=null;this.lastTicks=[];this.pointers=[];this.eventHandler=e}i(t,[{key:"loadFile",value:function t(r){var n=e("fs");this.buffer=n.readFileSync(r);return this.fileLoaded()}},{key:"loadArrayBuffer",value:function e(t){this.buffer=new Uint8Array(t);return this.fileLoaded()}},{key:"loadDataUri",value:function e(t){var r=atob(t.split(",")[1]);var n=t.split(",")[0].split(":")[1].split(";")[0];var i=new Uint8Array(r.length);for(var a=0;a<r.length;a++){i[a]=r.charCodeAt(a)}this.buffer=i;return this.fileLoaded()}},{key:"fileLoaded",value:function e(){if(!this.validate())throw"Invalid MIDI file; should start with MThd";this.getDivision().getTracks();return this}},{key:"validate",value:function e(){return u.bytesToLetters(this.buffer.slice(0,4))==="MThd"}},{key:"getLength",value:function e(){this.buffer.slice(4,8).forEach(function(e){console.log(e)});return this.buffer.slice(4,8)}},{key:"getFormat",value:function e(){return u.bytesToNumber(this.buffer.slice(8,10))}},{key:"getTrackCount",value:function e(){return u.bytesToNumber(this.buffer.slice(10,12))}},{key:"getTracks",value:function e(){this.tracks=[];this.pointers=[];this.lastTicks=[];this.tracksEnabled=[];this.buffer.forEach(function(e,t){if(u.bytesToLetters(this.buffer.slice(t,t+4))=="MTrk"){var r=u.bytesToNumber(this.buffer.slice(t+4,t+8));this.tracks.push(this.buffer.slice(t+8,t+8+r));this.pointers.push(0);this.lastTicks.push(0);this.tracksEnabled.push(1)}},this);return this}},{key:"enableTrack",value:function e(t){this.tracksEnabled[t-1]=1;return this}},{key:"disableTrack",value:function e(t){this.tracksEnabled[t-1]=0;return this}},{key:"getDivision",value:function e(){this.division=u.bytesToNumber(this.buffer.slice(12,14));return this}},{key:"handleEvent",value:function e(t){var r=this.tracks[t];var n=this.pointers[t];var i=this.getDeltaByteCount(t);var a=u.readVarInt(r.slice(n,n+i));var s=r[n+i];if(this.pointers[t]<this.tracks[t].length&&this.tick-this.lastTicks[t]>=a){var o=this.parseEvent(t,i);if(this.tracksEnabled[t]==1)this.emitEvent(o)}}},{key:"play",value:function e(){if(this.setIntervalId){console.log("Already playing...");return false}if(!this.startTime){this.startTime=(new Date).getTime()}var t=this;this.setIntervalId=setInterval(function(){t.tick=t.getCurrentTick();for(var e=0;e<=t.tracks.length-1;e++){if(t.endOfFile()){clearInterval(t.setIntervalId)}else{t.handleEvent(e)}}},1);return this}},{key:"pause",value:function e(){clearInterval(this.setIntervalId);this.setIntervalId=false;return this}},{key:"stop",value:function e(){clearInterval(this.setIntervalId);this.setIntervalId=false;this.startTime=0;return this.fileLoaded()}},{key:"isPlaying",value:function e(){return this.setIntervalId>0}},{key:"endOfTrack",value:function e(t){var r=this.pointers[t];if(this.tracks[t][r+1]==255&&this.tracks[t][r+2]==47&&this.tracks[t][r+3]==0){return true}return false}},{key:"endOfFile",value:function e(){return 14+this.tracks.length*8+this.pointers.reduce(function(e,t){return e+t},0)==this.buffer.length}},{key:"getDeltaByteCount",value:function e(t){var r=this.tracks[t];var n=this.pointers[t];var i=r[n];var a=1;while(i>=128){i=r[n+a];a++}return a}},{key:"getCurrentTick",value:function e(){return Math.round(((new Date).getTime()-this.startTime)/1e3*(this.division*(this.tempo/60)))}},{key:"emitEvent",value:function e(t){if(typeof this.eventHandler==="function")this.eventHandler(t)}},{key:"parseEvent",value:function e(t,r){var i=this.tracks[t];var a=this.pointers[t]+r;var s={};s.track=t+1;s.delta=u.readVarInt(i.slice(this.pointers[t],this.pointers[t]+r));this.lastTicks[t]=this.lastTicks[t]+s.delta;if(i[a]==255){switch(i[a+1]){case 0:s.name="Sequence Number";break;case 1:s.name="Text Event";break;case 2:s.name="Copyright Notice";break;case 3:s.name="Sequence/Track Name";var o=this.pointers[t];var l=1;while(o>=128){o=i[this.pointers[t]+l];l++}s.vlv=l;var f=u.readVarInt(i.slice(a+2,a+2+l));s.stringLength=f;s.string=u.bytesToLetters(i.slice(a+l+2,a+l+f+2));break;case 4:s.name="Instrument Name";break;case 5:s.name="Lyric";break;case 6:s.name="Marker";break;case 7:s.name="Cue Point";break;case 32:s.name="MIDI Channel Prefix";break;case 47:s.name="End of Track";break;case 81:s.name="Set Tempo";s.data=6e7/u.bytesToNumber(i.slice(a+3,a+6));this.tempo=s.data;break;case 84:s.name="SMTPE Offset";break;case 88:s.name="Time Signature";break;case 89:s.name="Key Signature";break;case 127:s.name="Sequencer-Specific Meta-event";break}var f=i[this.pointers[t]+r+2];this.pointers[t]+=f+4}else{if(i[a]<128){s.running=true;s.noteNumber=i[a+1];s.noteName=n.NOTES[i[a]];s.velocity=i[a+1];if(this.lastStatuses[t]<=143){s.name="Note off"}else if(this.lastStatuses[t]<=159){s.name="Note on"}this.pointers[t]+=r+2}else{this.lastStatuses[t]=i[a];if(i[a]<=143){s.name="Note off";s.noteNumber=i[a+1];s.noteName=n.NOTES[i[a+1]];s.velocity=Math.round(i[a+2]/127*100);this.pointers[t]+=r+3}else if(i[a]<=159){s.name="Note on";s.noteNumber=i[a+1];s.noteName=n.NOTES[i[a+1]];s.velocity=Math.round(i[a+2]/127*100);this.pointers[t]+=r+3}else if(i[a]<=175){s.name="Polyphonic Key Pressure";s.note=n.NOTES[i[a+1]];s.pressure=event[2];this.pointers[t]+=r+3}else if(i[a]<=191){s.name="Controller Change";s.number=i[a+1];s.value=i[a+2];this.pointers[t]+=r+3}else if(i[a]<=207){s.name="Program Change";this.pointers[t]+=r+2}else if(i[a]<=223){s.name="Channel Key Pressure";this.pointers[t]+=r+2}else if(i[a]<=239){s.name="Pitch Bend";this.pointers[t]+=r+3}}}return s}}]);return t}();r.Player=s;"use strict";var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,r,n){if(r)e(t.prototype,r);if(n)e(t,n);return t}}();function a(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var u=function(){function e(){a(this,e)}i(e,null,[{key:"byteToHex",value:function e(t){return t.toString(16)}},{key:"bytesToHex",value:function t(r){var n=[];r.forEach(function(t){n.push(e.byteToHex(t))});return n.join("")}},{key:"hexToNumber",value:function e(t){return parseInt(t,16)}},{key:"bytesToNumber",value:function t(r){return e.hexToNumber(e.bytesToHex(r))}},{key:"bytesToLetters",value:function e(t){var r=[];t.forEach(function(e){r.push(String.fromCharCode(e))});return r.join("")}},{key:"decToBinary",value:function e(t){return(t>>>0).toString(2)}},{key:"readVarInt",value:function e(t){var r=0;t.forEach(function(e){var t=e;if(t&128){r+=t&127;r<<=7}else{r+=t}});return r}}]);return e}()},{fs:1}]},{},[]);
