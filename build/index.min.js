"use strict";var Constants={NOTES:[]};(function(){var e=[["C"],["C#","Db"],["D"],["D#","Eb"],["E"],["F"],["F#","Gb"],["G"],["G#","Ab"],["A"],["A#","Bb"],["B"]];var t=0;for(var r=-1;r<=9;r++){e.forEach(function(e){e.forEach(function(e){Constants.NOTES[t]=e+r});t++})}})();"use strict";var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,r,n){if(r)e(t.prototype,r);if(n)e(t,n);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Player=function(){function e(t){_classCallCheck(this,e);this.startTime=0;this.pointers=[];this.buffer;this.division;this.setIntervalId;this.tracks=[];this.tracksEnabled=[];this.tempo=100;this.tick=0;this.lastStatuses=[];this.lastTick=null;this.lastTicks=[];this.eventHandler=t}_createClass(e,[{key:"loadFile",value:function e(t){var r=require("fs");this.buffer=r.readFileSync(t);return this.fileLoaded()}},{key:"loadArrayBuffer",value:function e(t){this.buffer=new Uint8Array(t);return this.fileLoaded()}},{key:"loadDataUri",value:function e(t){this.buffer=array;return this.fileLoaded()}},{key:"fileLoaded",value:function e(){if(!this.validate())throw"Invalid file; should start with MThd";this.getDivision().getTracks();return this}},{key:"validate",value:function e(){return Utils.bytesToLetters(this.buffer.slice(0,4))==="MThd"}},{key:"getLength",value:function e(){this.buffer.slice(4,8).forEach(function(e){console.log(e)});return this.buffer.slice(4,8)}},{key:"getFormat",value:function e(){return Utils.bytesToNumber(this.buffer.slice(8,10))}},{key:"getTrackCount",value:function e(){return Utils.bytesToNumber(this.buffer.slice(10,12))}},{key:"getTracks",value:function e(){this.buffer.forEach(function(e,t){if(Utils.bytesToLetters(this.buffer.slice(t,t+4))=="MTrk"){var r=Utils.bytesToNumber(this.buffer.slice(t+4,t+8));this.tracks.push(this.buffer.slice(t+8,t+8+r));this.pointers.push(0);this.lastTicks.push(0);this.tracksEnabled.push(1)}},this);return this}},{key:"enableTrack",value:function e(t){this.tracksEnabled[t-1]=1;return this}},{key:"disableTrack",value:function e(t){this.tracksEnabled[t-1]=0;return this}},{key:"getDivision",value:function e(){this.division=Utils.bytesToNumber(this.buffer.slice(12,14));return this}},{key:"handleEvent",value:function e(t){var r=this.tracks[t];var n=this.pointers[t];var i=this.getDeltaByteCount(t);var s=Utils.readVarInt(r.slice(n,n+i));var a=r[n+i];if(this.pointers[t]<this.tracks[t].length&&this.tick-this.lastTicks[t]>=s){var u=this.parseEvent(t,i);if(this.tracksEnabled[t]==1)this.emitEvent(u)}}},{key:"play",value:function e(){this.startTime=(new Date).getTime();var t=this;this.setIntervalId=setInterval(function(){t.tick=t.getCurrentTick();for(var e=0;e<=t.tracks.length-1;e++){if(t.endOfFile()){clearInterval(t.setIntervalId)}else{t.handleEvent(e)}}},1);return this}},{key:"endOfTrack",value:function e(t){var r=this.pointers[t];if(this.tracks[t][r+1]==255&&this.tracks[t][r+2]==47&&this.tracks[t][r+3]==0){return true}return false}},{key:"endOfFile",value:function e(){return 14+this.tracks.length*8+this.pointers.reduce(function(e,t){return e+t},0)==this.buffer.length}},{key:"getDeltaByteCount",value:function e(t){var r=this.tracks[t];var n=this.pointers[t];var i=r[n];var s=1;while(i>=128){i=r[n+s];s++}return s}},{key:"getCurrentTick",value:function e(){return Math.round(((new Date).getTime()-this.startTime)/1e3*(this.division*(this.tempo/60)))}},{key:"emitEvent",value:function e(t){if(typeof this.eventHandler==="function")this.eventHandler(t)}},{key:"parseEvent",value:function e(t,r){var n=this.tracks[t];var i=this.pointers[t]+r;var s={};s.track=t+1;s.delta=Utils.readVarInt(n.slice(this.pointers[t],this.pointers[t]+r));this.lastTicks[t]=this.lastTicks[t]+s.delta;if(n[i]==255){switch(n[i+1]){case 0:s.name="Sequence Number";break;case 1:s.name="Text Event";break;case 2:s.name="Copyright Notice";break;case 3:s.name="Sequence/Track Name";var a=this.pointers[t];var u=1;while(a>=128){a=n[this.pointers[t]+u];u++}s.vlv=u;var o=Utils.readVarInt(n.slice(i+2,i+2+u));s.stringLength=o;s.string=Utils.bytesToLetters(n.slice(i+u+2,i+u+o+2));break;case 4:s.name="Instrument Name";break;case 5:s.name="Lyric";break;case 6:s.name="Marker";break;case 7:s.name="Cue Point";break;case 32:s.name="MIDI Channel Prefix";break;case 47:s.name="End of Track";break;case 81:s.name="Set Tempo";s.data=Utils.bytesToNumber(n.slice(i+3,i+6));break;case 84:s.name="SMTPE Offset";break;case 88:s.name="Time Signature";break;case 89:s.name="Key Signature";break;case 127:s.name="Sequencer-Specific Meta-event";break}var o=n[this.pointers[t]+r+2];this.pointers[t]+=o+4}else{if(n[i]<128){s.running=true;s.noteNumber=n[i+1];s.noteName=Constants.NOTES[n[i]];s.velocity=n[i+1];if(this.lastStatuses[t]<=143){s.name="Note off"}else if(this.lastStatuses[t]<=159){s.name="Note on"}this.pointers[t]+=r+2}else{this.lastStatuses[t]=n[i];if(n[i]<=143){s.name="Note off";s.noteNumber=n[i+1];s.noteName=Constants.NOTES[n[i+1]];this.pointers[t]+=r+3}else if(n[i]<=159){s.name="Note on";s.noteNumber=n[i+1];s.noteName=Constants.NOTES[n[i+1]];this.pointers[t]+=r+3}else if(n[i]<=175){s.name="Polyphonic Key Pressure";s.note=Constants.NOTES[n[i+1]];s.pressure=event[2];this.pointers[t]+=r+3}else if(n[i]<=191){s.name="Controller Change";s.number=n[i+1];s.value=n[i+2];this.pointers[t]+=r+3}else if(n[i]<=207){s.name="Program Change";this.pointers[t]+=r+2}else if(n[i]<=223){s.name="Channel Key Pressure";this.pointers[t]+=r+2}else if(n[i]<=239){s.name="Pitch Bend";this.pointers[t]+=r+3}}}return s}}]);return e}();exports.Player=Player;"use strict";var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,r,n){if(r)e(t.prototype,r);if(n)e(t,n);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Utils=function(){function e(){_classCallCheck(this,e)}_createClass(e,null,[{key:"byteToHex",value:function e(t){return t.toString(16)}},{key:"bytesToHex",value:function t(r){var n=[];r.forEach(function(t){n.push(e.byteToHex(t))});return n.join("")}},{key:"hexToNumber",value:function e(t){return parseInt(t,16)}},{key:"bytesToNumber",value:function t(r){return e.hexToNumber(e.bytesToHex(r))}},{key:"bytesToLetters",value:function e(t){var r=[];t.forEach(function(e){r.push(String.fromCharCode(e))});return r.join("")}},{key:"decToBinary",value:function e(t){return(t>>>0).toString(2)}},{key:"readVarInt",value:function e(t){var r=0;t.forEach(function(e){var t=e;if(t&128){r+=t&127;r<<=7}else{r+=t}});return r}}]);return e}();
