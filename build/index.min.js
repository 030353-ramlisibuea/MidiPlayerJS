"use strict";var Constants={NOTES:[]};(function(){var e=[["C"],["C#","Db"],["D"],["D#","Eb"],["E"],["F"],["F#","Gb"],["G"],["G#","Ab"],["A"],["A#","Bb"],["B"]];var t=0;for(var s=-1;s<=9;s++){e.forEach(function(e){e.forEach(function(e){Constants.NOTES[t]=e+s});t++})}})();exports.Constants=Constants;"use strict";var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,s,n){if(s)e(t.prototype,s);if(n)e(t,n);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var fs=require("fs");var Player=function(){function e(t){_classCallCheck(this,e);this.startTime=0;this.pointers=[];this.buffer;this.division;this.setIntervalId;this.tracks=[];this.tracksEnabled=[];this.tempo=100;this.tick=0;this.lastStatuses=[];this.lastTick=null;this.lastTicks=[];this.eventHandler=t}_createClass(e,[{key:"loadFile",value:function e(t){this.buffer=fs.readFileSync(t);if(!this.validate())throw"Invalid file; should start with MThd";this.getDivision().getTracks();return this}},{key:"loadArray",value:function e(t){this.buffer=t}},{key:"validate",value:function e(){return Utils.bytesToLetters(this.buffer.slice(0,4))==="MThd"}},{key:"getLength",value:function e(){this.buffer.slice(4,8).forEach(function(e){console.log(e)});return this.buffer.slice(4,8)}},{key:"getFormat",value:function e(){return Utils.bytesToNumber(this.buffer.slice(8,10))}},{key:"getTrackCount",value:function e(){return Utils.bytesToNumber(this.buffer.slice(10,12))}},{key:"getTracks",value:function e(){this.buffer.forEach(function(e,t){if(Utils.bytesToLetters(this.buffer.slice(t,t+4))=="MTrk"){var s=Utils.bytesToNumber(this.buffer.slice(t+4,t+8));this.tracks.push(this.buffer.slice(t+8,t+8+s));this.pointers.push(0);this.lastTicks.push(0);this.tracksEnabled.push(1)}},this);return this}},{key:"enableTrack",value:function e(t){this.tracksEnabled[t-1]=1;return this}},{key:"disableTrack",value:function e(t){this.tracksEnabled[t-1]=0;return this}},{key:"getDivision",value:function e(){this.division=Utils.bytesToNumber(this.buffer.slice(12,14));return this}},{key:"handleEvent",value:function e(t){var s=this.tracks[t];var n=this.pointers[t];var r=this.getDeltaByteCount(t);var i=Utils.readVarInt(s.slice(n,n+r));var a=s[n+r];if(this.pointers[t]<this.tracks[t].length&&this.tick-this.lastTicks[t]>=i){var u=this.parseEvent(t,r);if(this.tracksEnabled[t]==1)this.emitEvent(u)}}},{key:"play",value:function e(){this.startTime=(new Date).getTime();var t=this;this.setIntervalId=setInterval(function(){t.tick=t.getCurrentTick();for(var e=0;e<=t.tracks.length-1;e++){if(t.endOfFile()){clearInterval(t.setIntervalId)}else{t.handleEvent(e)}}},1);return this}},{key:"endOfTrack",value:function e(t){var s=this.pointers[t];if(this.tracks[t][s+1]==255&&this.tracks[t][s+2]==47&&this.tracks[t][s+3]==0){return true}return false}},{key:"endOfFile",value:function e(){return 14+this.tracks.length*8+this.pointers.reduce(function(e,t){return e+t},0)==this.buffer.length}},{key:"getDeltaByteCount",value:function e(t){var s=this.tracks[t];var n=this.pointers[t];var r=s[n];var i=1;while(r>=128){r=s[n+i];i++}return i}},{key:"getCurrentTick",value:function e(){return Math.round(((new Date).getTime()-this.startTime)/1e3*(this.division*(this.tempo/60)))}},{key:"emitEvent",value:function e(t){if(typeof this.eventHandler==="function")this.eventHandler(t)}},{key:"parseEvent",value:function e(t,s){var n=this.tracks[t];var r=this.pointers[t]+s;var i={};i.track=t+1;i.delta=Utils.readVarInt(n.slice(this.pointers[t],this.pointers[t]+s));this.lastTicks[t]=this.lastTicks[t]+i.delta;if(n[r]==255){switch(n[r+1]){case 0:i.name="Sequence Number";break;case 1:i.name="Text Event";break;case 2:i.name="Copyright Notice";break;case 3:i.name="Sequence/Track Name";var a=this.pointers[t];var u=1;while(a>=128){a=n[this.pointers[t]+u];u++}i.vlv=u;var o=Utils.readVarInt(n.slice(r+2,r+2+u));i.stringLength=o;i.string=Utils.bytesToLetters(n.slice(r+u+2,r+u+o+2));break;case 4:i.name="Instrument Name";break;case 5:i.name="Lyric";break;case 6:i.name="Marker";break;case 7:i.name="Cue Point";break;case 32:i.name="MIDI Channel Prefix";break;case 47:i.name="End of Track";break;case 81:i.name="Set Tempo";i.data=Utils.bytesToNumber(n.slice(r+3,r+6));break;case 84:i.name="SMTPE Offset";break;case 88:i.name="Time Signature";break;case 89:i.name="Key Signature";break;case 127:i.name="Sequencer-Specific Meta-event";break}var o=n[this.pointers[t]+s+2];this.pointers[t]+=o+4}else{if(n[r]<128){i.running=true;i.noteNumber=n[r+1];i.noteName=Constants.NOTES[n[r]];i.velocity=n[r+1];if(this.lastStatuses[t]<=143){i.name="Note off"}else if(this.lastStatuses[t]<=159){i.name="Note on"}this.pointers[t]+=s+2}else{this.lastStatuses[t]=n[r];if(n[r]<=143){i.name="Note off";i.noteNumber=n[r+1];i.noteName=Constants.NOTES[n[r+1]];this.pointers[t]+=s+3}else if(n[r]<=159){i.name="Note on";i.noteNumber=n[r+1];i.noteName=Constants.NOTES[n[r+1]];this.pointers[t]+=s+3}else if(n[r]<=175){i.name="Polyphonic Key Pressure";i.note=Constants.NOTES[n[r+1]];i.pressure=event[2];this.pointers[t]+=s+3}else if(n[r]<=191){i.name="Controller Change";i.number=n[r+1];i.value=n[r+2];this.pointers[t]+=s+3}else if(n[r]<=207){i.name="Program Change";this.pointers[t]+=s+2}else if(n[r]<=223){i.name="Channel Key Pressure";this.pointers[t]+=s+2}else if(n[r]<=239){i.name="Pitch Bend";this.pointers[t]+=s+3}}}return i}}]);return e}();exports.Player=Player;"use strict";var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,s,n){if(s)e(t.prototype,s);if(n)e(t,n);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Utils=function(){function e(){_classCallCheck(this,e)}_createClass(e,null,[{key:"byteToHex",value:function e(t){return t.toString(16)}},{key:"bytesToHex",value:function t(s){var n=[];s.forEach(function(t){n.push(e.byteToHex(t))});return n.join("")}},{key:"hexToNumber",value:function e(t){return parseInt(t,16)}},{key:"bytesToNumber",value:function t(s){return e.hexToNumber(e.bytesToHex(s))}},{key:"bytesToLetters",value:function e(t){var s=[];t.forEach(function(e){s.push(String.fromCharCode(e))});return s.join("")}},{key:"decToBinary",value:function e(t){return(t>>>0).toString(2)}},{key:"readVarInt",value:function e(t){var s=0;t.forEach(function(e){var t=e;if(t&128){s+=t&127;s<<=7}else{s+=t}});return s}}]);return e}();exports.Utils=Utils;
