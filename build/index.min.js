"use strict";var Constants={NOTES:[]};(function(){var e=[["C"],["C#","Db"],["D"],["D#","Eb"],["E"],["F"],["F#","Gb"],["G"],["G#","Ab"],["A"],["A#","Bb"],["B"]];var t=0;for(var n=-1;n<=9;n++){e.forEach(function(e){e.forEach(function(e){Constants.NOTES[t]=e+n});t++})}})();exports.Constants=Constants;"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}return function(t,n,s){if(n)e(t.prototype,n);if(s)e(t,s);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var fs=require("fs");var Player=function(){function e(t){_classCallCheck(this,e);this.startTime=0;this.pointers=[];this.buffer;this.division;this.setIntervalId;this.tracks=[];this.tempo=100;this.tick=0;this.lastStatuses=[];this.lastTick=null;this.lastTicks=[];this.eventHandler=t}_createClass(e,[{key:"loadFile",value:function e(t){this.buffer=fs.readFileSync(t);if(!this.validate())throw"Invalid file; should start with MThd";this.getDivision().getTracks();return this}},{key:"loadArray",value:function e(t){this.buffer=t}},{key:"validate",value:function e(){return Utils.bytesToLetters(this.buffer.slice(0,4))==="MThd"}},{key:"getLength",value:function e(){this.buffer.slice(4,8).forEach(function(e){console.log(e)});return this.buffer.slice(4,8)}},{key:"getFormat",value:function e(){return Utils.bytesToNumber(this.buffer.slice(8,10))}},{key:"getTrackCount",value:function e(){return Utils.bytesToNumber(this.buffer.slice(10,12))}},{key:"getTracks",value:function e(){this.buffer.forEach(function(e,t){if(Utils.bytesToLetters(this.buffer.slice(t,t+4))=="MTrk"){var n=Utils.bytesToNumber(this.buffer.slice(t+4,t+8));this.tracks.push(this.buffer.slice(t+8,t+8+n));this.pointers.push(0);this.lastTicks.push(0)}},this);return this}},{key:"getDivision",value:function e(){this.division=Utils.bytesToNumber(this.buffer.slice(12,14));return this}},{key:"handleEvent",value:function e(t){var n=this.tracks[t];var s=this.pointers[t];var r=this.getDeltaByteCount(t);var i=Utils.readVarInt(n.slice(s,s+r));var a=n[s+r];if(this.tick-this.lastTicks[t]>=i){this.lastTicks[t]=this.tick;this.emitEvent(this.parseEvent(t,r))}}},{key:"play",value:function e(){this.startTime=(new Date).getTime();var t=this;this.setIntervalId=setInterval(function(){t.tick=t.getCurrentTick();for(var e=0;e<=t.tracks.length-1;e++){if(t.endOfTrack(e)){clearInterval(t.setIntervalId)}else{t.handleEvent(e)}}},1);return this}},{key:"endOfTrack",value:function e(t){var n=this.pointers[t];if(this.tracks[t][n+1]==255&&this.tracks[t][n+2]==47&&this.tracks[t][n+3]==0){return true}return false}},{key:"getDeltaByteCount",value:function e(t){var n=this.tracks[t];var s=this.pointers[t];var r=n[s];var i=1;while(r>=128){r=n[s+i];i++}return i}},{key:"getCurrentTick",value:function e(){return Math.round(((new Date).getTime()-this.startTime)/1e3*(this.division*(this.tempo/60)))}},{key:"emitEvent",value:function e(t){if(typeof this.eventHandler==="function")this.eventHandler(t)}},{key:"toggleTrack",value:function e(t){}},{key:"parseEvent",value:function e(t,n){console.log(this.tick);var s=this.tracks[t];var r=this.pointers[t]+n;var i={};i.track=t+1;i.delta=Utils.readVarInt(s.slice(this.pointers[t],this.pointers[t]+n));if(s[r]==255){switch(s[r+1]){case 0:i.name="Sequence Number";break;case 1:i.name="Text Event";break;case 2:i.name="Copyright Notice";break;case 3:i.name="Sequence/Track Name";var a=this.pointers[t];var o=1;while(a>=128){a=s[this.pointers[t]+o];o++}i.vlv=o;var u=Utils.readVarInt(s.slice(r+2,r+2+o));i.stringLength=u;i.string=Utils.bytesToLetters(s.slice(r+o+2,r+o+u+2));break;case 4:i.name="Instrument Name";break;case 5:i.name="Lyric";break;case 6:i.name="Marker";break;case 7:i.name="Cue Point";break;case 32:i.name="MIDI Channel Prefix";break;case 47:i.name="End of Track";break;case 81:i.name="Set Tempo";i.data=Utils.bytesToNumber(s.slice(r+3,r+6));break;case 84:i.name="SMTPE Offset";break;case 88:i.name="Time Signature";break;case 89:i.name="Key Signature";break;case 127:i.name="Sequencer-Specific Meta-event";break}var u=s[this.pointers[t]+n+2];this.pointers[t]+=u+4}else{if(s[r]<128){i.running=true;i.noteNumber=s[r+1];i.noteName=Constants.NOTES[s[r]];i.velocity=s[r+1];if(this.lastStatuses[t]<=143){i.name="Note off"}else if(this.lastStatuses[t]<=159){i.name="Note on"}this.pointers[t]+=n+2}else{this.lastStatuses[t]=s[r];if(s[r]<=143){i.name="Note off";i.noteNumber=s[r+1];i.noteName=Constants.NOTES[s[r+1]];this.pointers[t]+=n+3}else if(s[r]<=159){i.name="Note on";i.noteNumber=s[r+1];i.noteName=Constants.NOTES[s[r+1]];this.pointers[t]+=n+3}else if(s[r]<=175){i.name="Polyphonic Key Pressure";i.note=Constants.NOTES[s[r+1]];i.pressure=event[2];this.pointers[t]+=n+3}else if(s[r]<=191){i.name="Controller Change";i.number=s[r+1];i.value=s[r+2];this.pointers[t]+=n+3}else if(s[r]<=207){i.name="Program Change";this.pointers[t]+=n+2}else if(s[r]<=223){i.name="Channel Key Pressure";this.pointers[t]+=n+2}else if(s[r]<=239){i.name="Pitch Bend";this.pointers[t]+=n+3}}}return i}}]);return e}();exports.Player=Player;"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}return function(t,n,s){if(n)e(t.prototype,n);if(s)e(t,s);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var Utils=function(){function e(){_classCallCheck(this,e)}_createClass(e,null,[{key:"byteToHex",value:function e(t){return t.toString(16)}},{key:"bytesToHex",value:function t(n){var s=[];n.forEach(function(t){s.push(e.byteToHex(t))});return s.join("")}},{key:"hexToNumber",value:function e(t){return parseInt(t,16)}},{key:"bytesToNumber",value:function t(n){return e.hexToNumber(e.bytesToHex(n))}},{key:"bytesToLetters",value:function e(t){var n=[];t.forEach(function(e){n.push(String.fromCharCode(e))});return n.join("")}},{key:"decToBinary",value:function e(t){return(t>>>0).toString(2)}},{key:"readVarInt",value:function e(t){var n=0;t.forEach(function(e){var t=e;if(t&128){n+=t&127;n<<=7}else{n+=t}});return n}}]);return e}();exports.Utils=Utils;
